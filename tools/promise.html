<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise 对象 | Kaino·Lamperouge</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.539e4251.css" as="style"><link rel="preload" href="/blogs/assets/js/app.ce7ede7b.js" as="script"><link rel="preload" href="/blogs/assets/js/2.487b4d99.js" as="script"><link rel="preload" href="/blogs/assets/js/45.1caf120e.js" as="script"><link rel="prefetch" href="/blogs/assets/js/10.80cbf96f.js"><link rel="prefetch" href="/blogs/assets/js/11.c45194b4.js"><link rel="prefetch" href="/blogs/assets/js/12.2efdb192.js"><link rel="prefetch" href="/blogs/assets/js/13.10b60b19.js"><link rel="prefetch" href="/blogs/assets/js/14.6f5ffd95.js"><link rel="prefetch" href="/blogs/assets/js/15.33dd3631.js"><link rel="prefetch" href="/blogs/assets/js/16.153c9f54.js"><link rel="prefetch" href="/blogs/assets/js/17.d3d13da0.js"><link rel="prefetch" href="/blogs/assets/js/18.7f596757.js"><link rel="prefetch" href="/blogs/assets/js/19.d3a2e782.js"><link rel="prefetch" href="/blogs/assets/js/20.77743e4c.js"><link rel="prefetch" href="/blogs/assets/js/21.a30af7e4.js"><link rel="prefetch" href="/blogs/assets/js/22.c0f4dfd0.js"><link rel="prefetch" href="/blogs/assets/js/23.e9479e63.js"><link rel="prefetch" href="/blogs/assets/js/24.b988021c.js"><link rel="prefetch" href="/blogs/assets/js/25.e4ad174d.js"><link rel="prefetch" href="/blogs/assets/js/26.bafad003.js"><link rel="prefetch" href="/blogs/assets/js/27.9249910c.js"><link rel="prefetch" href="/blogs/assets/js/28.950707e6.js"><link rel="prefetch" href="/blogs/assets/js/29.bf869df0.js"><link rel="prefetch" href="/blogs/assets/js/3.e528ebb8.js"><link rel="prefetch" href="/blogs/assets/js/30.b031c849.js"><link rel="prefetch" href="/blogs/assets/js/31.5400d7fb.js"><link rel="prefetch" href="/blogs/assets/js/32.c115fe94.js"><link rel="prefetch" href="/blogs/assets/js/33.a59460b4.js"><link rel="prefetch" href="/blogs/assets/js/34.58791948.js"><link rel="prefetch" href="/blogs/assets/js/35.9827412c.js"><link rel="prefetch" href="/blogs/assets/js/36.fcd58bb9.js"><link rel="prefetch" href="/blogs/assets/js/37.9e8b88c2.js"><link rel="prefetch" href="/blogs/assets/js/38.ec287719.js"><link rel="prefetch" href="/blogs/assets/js/39.a6c2817d.js"><link rel="prefetch" href="/blogs/assets/js/4.bb4a3f3b.js"><link rel="prefetch" href="/blogs/assets/js/40.a9735c86.js"><link rel="prefetch" href="/blogs/assets/js/41.cd113c63.js"><link rel="prefetch" href="/blogs/assets/js/42.d905a84f.js"><link rel="prefetch" href="/blogs/assets/js/43.af91aceb.js"><link rel="prefetch" href="/blogs/assets/js/44.3223b301.js"><link rel="prefetch" href="/blogs/assets/js/46.87734e69.js"><link rel="prefetch" href="/blogs/assets/js/47.ba0da5fa.js"><link rel="prefetch" href="/blogs/assets/js/48.4bcb31ac.js"><link rel="prefetch" href="/blogs/assets/js/49.3326df5f.js"><link rel="prefetch" href="/blogs/assets/js/5.78e26efb.js"><link rel="prefetch" href="/blogs/assets/js/50.7b0acd87.js"><link rel="prefetch" href="/blogs/assets/js/51.5497ff88.js"><link rel="prefetch" href="/blogs/assets/js/52.48607488.js"><link rel="prefetch" href="/blogs/assets/js/53.9ce906eb.js"><link rel="prefetch" href="/blogs/assets/js/54.23ef8813.js"><link rel="prefetch" href="/blogs/assets/js/6.94f35d6d.js"><link rel="prefetch" href="/blogs/assets/js/7.91a26545.js"><link rel="prefetch" href="/blogs/assets/js/8.11b78e3f.js"><link rel="prefetch" href="/blogs/assets/js/9.80035b18.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.539e4251.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><!----> <span class="site-name">Kaino·Lamperouge</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Canvas" class="dropdown-title"><span class="title">Canvas</span> <span class="arrow down"></span></button> <button type="button" aria-label="Canvas" class="mobile-dropdown-title"><span class="title">Canvas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/canvas/Canvas.html" class="nav-link">
  Canvas
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/OpenGL.html" class="nav-link">
  GLSL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/Three.js.html" class="nav-link">
  Three.js
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGL.html" class="nav-link">
  WebGL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGLProgram.html" class="nav-link">
  WebGLProgram
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Chrome" class="dropdown-title"><span class="title">Chrome</span> <span class="arrow down"></span></button> <button type="button" aria-label="Chrome" class="mobile-dropdown-title"><span class="title">Chrome</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/chrome/Extension.html" class="nav-link">
  扩展
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="uni-app" class="dropdown-title"><span class="title">uni-app</span> <span class="arrow down"></span></button> <button type="button" aria-label="uni-app" class="mobile-dropdown-title"><span class="title">uni-app</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/uniapp/import.html" class="nav-link">
  引用
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/CSS.html" class="nav-link">
  CSS 变量
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/modifier.html" class="nav-link">
  事件修饰符
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/component.html" class="nav-link">
  组件
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/python/Underline.html" class="nav-link">
  下划线
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MiniProject" class="dropdown-title"><span class="title">MiniProject</span> <span class="arrow down"></span></button> <button type="button" aria-label="MiniProject" class="mobile-dropdown-title"><span class="title">MiniProject</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Timer.html" class="nav-link">
  计时器
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Demo.html" class="nav-link">
  demo
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Batch.html" class="nav-link">
  批量删除
</a></li></ul></div></div><div class="nav-item"><a href="/blogs/about/" class="nav-link">
  About
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Canvas" class="dropdown-title"><span class="title">Canvas</span> <span class="arrow down"></span></button> <button type="button" aria-label="Canvas" class="mobile-dropdown-title"><span class="title">Canvas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/canvas/Canvas.html" class="nav-link">
  Canvas
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/OpenGL.html" class="nav-link">
  GLSL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/Three.js.html" class="nav-link">
  Three.js
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGL.html" class="nav-link">
  WebGL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGLProgram.html" class="nav-link">
  WebGLProgram
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Chrome" class="dropdown-title"><span class="title">Chrome</span> <span class="arrow down"></span></button> <button type="button" aria-label="Chrome" class="mobile-dropdown-title"><span class="title">Chrome</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/chrome/Extension.html" class="nav-link">
  扩展
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="uni-app" class="dropdown-title"><span class="title">uni-app</span> <span class="arrow down"></span></button> <button type="button" aria-label="uni-app" class="mobile-dropdown-title"><span class="title">uni-app</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/uniapp/import.html" class="nav-link">
  引用
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/CSS.html" class="nav-link">
  CSS 变量
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/modifier.html" class="nav-link">
  事件修饰符
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/component.html" class="nav-link">
  组件
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/python/Underline.html" class="nav-link">
  下划线
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MiniProject" class="dropdown-title"><span class="title">MiniProject</span> <span class="arrow down"></span></button> <button type="button" aria-label="MiniProject" class="mobile-dropdown-title"><span class="title">MiniProject</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Timer.html" class="nav-link">
  计时器
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Demo.html" class="nav-link">
  demo
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Batch.html" class="nav-link">
  批量删除
</a></li></ul></div></div><div class="nav-item"><a href="/blogs/about/" class="nav-link">
  About
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blogs/" class="sidebar-heading clickable router-link-active open"><span>Tools</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/tools/CSS/animation.html" class="sidebar-link">animation</a></li><li><a href="/blogs/tools/CSS/keyframes.html" class="sidebar-link">@keyframes</a></li><li><a href="/blogs/tools/JavaScript/copy.html" class="sidebar-link">浅拷贝深拷贝</a></li><li><a href="/blogs/tools/JavaScript/cursor.html" class="sidebar-link">更改鼠标指针</a></li><li><a href="/blogs/tools/JavaScript/event.html" class="sidebar-link">事件流</a></li><li><a href="/blogs/tools/JavaScript/export.html" class="sidebar-link">Export</a></li><li><a href="/blogs/tools/JavaScript/grammar.html" class="sidebar-link">Grammar</a></li><li><a href="/blogs/tools/JavaScript/object.html" class="sidebar-link">Object</a></li><li><a href="/blogs/tools/JavaScript/void.html" class="sidebar-link">Void</a></li><li><a href="/blogs/tools/Business Consumer.html" class="sidebar-link">B端C端</a></li><li><a href="/blogs/tools/closure.html" class="sidebar-link">闭包</a></li><li><a href="/blogs/tools/css preprocessor.html" class="sidebar-link">Css预处理器</a></li><li><a href="/blogs/tools/debounce throttle.html" class="sidebar-link">防抖和节流</a></li><li><a href="/blogs/tools/debugger.html" class="sidebar-link">断点调试</a></li><li><a href="/blogs/tools/hook.html" class="sidebar-link">钩子函数</a></li><li><a href="/blogs/tools/git.html" class="sidebar-link">Git</a></li><li><a href="/blogs/tools/Low Code.html" class="sidebar-link">低代码</a></li><li><a href="/blogs/tools/markdown.html" class="sidebar-link">md语法</a></li><li><a href="/blogs/tools/Memory Leak.html" class="sidebar-link">内存泄漏</a></li><li><a href="/blogs/tools/MVC.html" class="sidebar-link">MVC</a></li><li><a href="/blogs/tools/MVVM.html" class="sidebar-link">MVVM</a></li><li><a href="/blogs/tools/npm.html" class="sidebar-link">NPM</a></li><li><a href="/blogs/tools/optimize.html" class="sidebar-link">优化</a></li><li><a href="/blogs/tools/promise.html" aria-current="page" class="active sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-对象的状态" class="sidebar-link">Promise 对象的状态</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#基本用法" class="sidebar-link">基本用法</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-prototype-then" class="sidebar-link">Promise.prototype.then()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-prototype-catch" class="sidebar-link">Promise.prototype.catch()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-prototype-finally" class="sidebar-link">Promise.prototype.finally()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-all" class="sidebar-link">Promise.all()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-race" class="sidebar-link">Promise.race()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-allsettled" class="sidebar-link">Promise.allSettled()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-any" class="sidebar-link">Promise.any()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-resolve" class="sidebar-link">Promise.resolve()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-reject" class="sidebar-link">Promise.reject()</a></li><li class="sidebar-sub-header"><a href="/blogs/tools/promise.html#promise-try" class="sidebar-link">Promise.try()</a></li></ul></li><li><a href="/blogs/tools/report errors.html" class="sidebar-link">报错</a></li><li><a href="/blogs/tools/shell.html" class="sidebar-link">Shell</a></li><li><a href="/blogs/tools/style.html" class="sidebar-link">Style</a></li><li><a href="/blogs/tools/timestamp.html" class="sidebar-link">时间戳</a></li><li><a href="/blogs/tools/URL Code.html" class="sidebar-link">URL编码</a></li><li><a href="/blogs/tools/URL Transfer Parameters.html" class="sidebar-link">URL携带参数缺失</a></li><li><a href="/blogs/tools/uuid.html" class="sidebar-link">UUID</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise-对象"><a href="#promise-对象" class="header-anchor">#</a> Promise 对象</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p><code>Promise</code> 是一个对象，也是一个构造函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步代码...</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Promise</code> 构造函数接受一个回调函数 f1 作为参数，f1 里面是异步操作的代码。</p> <p>返回的 p1 就是一个 <code>Promise</code> 实例</p> <h3 id="promise-的设计思想"><a href="#promise-的设计思想" class="header-anchor">#</a> Promise 的设计思想</h3> <p>所有异步任务都返回一个 <code>Promise</code> 实例</p> <p><code>Promise</code> 实例有一个 <code>then</code> 方法，用来指定下一步的回调函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// f1的异步操作执行完成，就会执行f2</span>
</code></pre></div><p><code>Promise</code> 对象通过自身的状态，来控制异步操作</p> <h2 id="promise-对象的状态"><a href="#promise-对象的状态" class="header-anchor">#</a> <code>Promise</code> 对象的状态</h2> <h3 id="promise-实例三种状态"><a href="#promise-实例三种状态" class="header-anchor">#</a> <code>Promise</code> 实例三种状态</h3> <ul><li>异步操作未完成（ pending ）</li> <li>异步操作成功（ fulfilled ）</li> <li>异步操作失败（ rejected ）</li></ul> <p><code>fulfilled</code> 和 <code>rejected</code> 合在一起称为 <code>resolved</code> （已定型）</p> <h3 id="promise-实例变化途径"><a href="#promise-实例变化途径" class="header-anchor">#</a> <code>Promise</code> 实例变化途径</h3> <ul><li>从&quot;未完成&quot;到&quot;成功&quot;</li> <li>从&quot;未完成&quot;到&quot;失败&quot;</li></ul> <p>一旦状态发生变化，就凝固了，不会再有新的状态变化。</p> <p>一旦承诺成效，就不得再改变了。</p> <p>这意味着，<code>Promise</code> 实例的状态变化只可能发生一次。</p> <h3 id="promise-的最终结果"><a href="#promise-的最终结果" class="header-anchor">#</a> <code>Promise</code> 的最终结果</h3> <ul><li>异步操作成功，<code>Promise</code> 实例传回一个值（ value ），状态变为 <code>fulfilled</code> 。</li> <li>异步操作失败，<code>Promise</code> 实例抛出一个错误（ error ），状态变为 <code>rejected</code> 。</li></ul> <h2 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h2> <h3 id="promise-构造函数"><a href="#promise-构造函数" class="header-anchor">#</a> <code>Promise</code> 构造函数</h3> <p>JavaScript 提供原生的Promise构造函数，用来生成 Promise 实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 异步操作成功 /){
    resolve(value);
  } else { / 异步操作失败 */</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>resolve</code> 函数的作用:</p> <p>将 <code>Promise</code> 实例的状态从&quot;未完成&quot;变为&quot;成功&quot;（即从 <code>pending</code> 变为 <code>fulfilled</code> ）</p> <p>在异步操作成功时调用，并将异步操作的结果，作为参数传递出去。</p> <p><code>reject</code> 函数的作用:</p> <p>将 <code>Promise</code> 实例的状态从从&quot;未完成&quot;变为&quot;失败&quot;（即从 <code>pending</code> 变为 <code>rejected</code> ）</p> <p>在异步操作失败时调用，并将异步操作报出的错误，作为参数传递出去。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> 
</code></pre></div><p>返回一个 <code>Promise</code> 实例。100 毫秒以后，该实例的状态会变为 <code>fulfilled</code></p> <h3 id="promise-新建后就会立即执行"><a href="#promise-新建后就会立即执行" class="header-anchor">#</a> <code>Promise</code> 新建后就会立即执行</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Promise</span>
<span class="token comment">// Hi!</span>
<span class="token comment">// resolved</span>
</code></pre></div><p>首先输出的是 Promise</p> <p>然后，<code>then</code> 方法指定的回调函数，将在当前脚本所有同步任务执行完才会执行</p> <p>所以 resolved 最后输出</p> <h3 id="异步加载图片"><a href="#异步加载图片" class="header-anchor">#</a> 异步加载图片</h3> <p>使用 <code>Promise</code> 包装了一个图片加载的异步操作</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">loadImageAsync</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    image<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Could not load image at '</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="用-promise-对象-实现的-ajax-操作"><a href="#用-promise-对象-实现的-ajax-操作" class="header-anchor">#</a> 用 <code>Promise</code> 对象 实现的 <code>Ajax</code> 操作</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">getJSON</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;/posts.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Contents: '</span> <span class="token operator">+</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>getJSON</code> 是对 <code>XMLHttpRequest</code> 对象的封装</p> <p>用于发出一个针对 <code>JSON</code> 数据的 <code>HTTP</code> 请求</p> <p>并且返回一个 <code>Promise</code> 对象</p> <p>注意: 在 <code>getJSON</code> 内部，<code>resolve</code> 函数和 <code>reject</code> 函数调用时，都带有参数</p> <p>如果调用 <code>resolve</code> 函数和 <code>reject</code> 函数时带有参数，那么它们的参数会被传递给回调函数。</p> <p><code>reject</code> 函数的参数通常是 <code>Error</code> 对象的实例，表示抛出的错误；</p> <h3 id="resolve-函数的参数除了正常的值以外-还可能是另一个-promise-实例"><a href="#resolve-函数的参数除了正常的值以外-还可能是另一个-promise-实例" class="header-anchor">#</a> <code>resolve</code> 函数的参数除了正常的值以外，还可能是另一个 <code>Promise</code> 实例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>p1</code> 和 <code>p2</code> 都是 <code>Promise</code> 的实例</p> <p><code>p2</code> 的 <code>resolve</code> 方法将 <code>p1</code> 作为参数，即一个异步操作的结果是返回另一个异步操作</p> <p><code>p1</code> 的状态就会传递给 <code>p2</code> ； <code>p1</code> 的状态决定了 <code>p2</code> 的状态</p> <p>如果 <code>p1</code> 的状态是 <code>pending</code> ，那么 <code>p2</code> 的回调函数就会等待 <code>p1</code> 的状态改变；</p> <h3 id="如果-p1-的状态已经是-resolved-或者-rejected-那么-p2-的回调函数将会立刻执行"><a href="#如果-p1-的状态已经是-resolved-或者-rejected-那么-p2-的回调函数将会立刻执行" class="header-anchor">#</a> 如果 <code>p1</code> 的状态已经是 <code>resolved</code> 或者 <code>rejected</code> ，那么 <code>p2</code> 的回调函数将会立刻执行</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  

<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p2
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Error: fail</span>
</code></pre></div><p><code>p1</code> 是一个 <code>Promise</code> ，3 秒之后变为 <code>rejected</code></p> <p><code>p2</code> 的状态在 1 秒之后改变，<code>resolve</code> 方法返回的是 <code>p1</code></p> <p><code>p2</code> 返回的是另一个 <code>Promise</code> ，导致 <code>p2</code> 自己的状态无效了，由 <code>p1</code> 的状态决定 <code>p2</code> 的状态。</p> <p>所以，后面的 <code>then</code> 语句都变成针对后者（<code>p1</code>）</p> <p>又过了 2 秒，<code>p1</code> 变为 <code>rejected</code>，导致触发 <code>catch</code> 方法指定的回调函数</p> <h3 id="调用-resolve-或-reject-并不会终结-promise-的参数函数的执行"><a href="#调用-resolve-或-reject-并不会终结-promise-的参数函数的执行" class="header-anchor">#</a> 调用 <code>resolve</code> 或 <code>reject</code> 并不会终结 <code>Promise</code> 的参数函数的执行</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2</span>
<span class="token comment">// 1</span>
</code></pre></div><p>调用 resolve(1) 以后，后面的 console.log(2) 还是会执行，并且会首先打印出来</p> <p>因为立即 <code>resolved</code> 的 <code>Promise</code> 是在本轮事件循环的末尾执行，总是晚于本轮循环的同步任务</p> <p>调用 <code>resolve</code> 或 <code>reject</code> 以后，<code>Promise</code> 的使命就完成了，</p> <p>后继操作应该放到 <code>then</code> 方法里面，而不应该直接写在 <code>resolve</code> 或 <code>reject</code> 的后面。</p> <p>所以，最好在它们前面加上 <code>return</code> 语句，这样就不会有意外</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 后面的语句不会执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="promise-prototype-then"><a href="#promise-prototype-then" class="header-anchor">#</a> Promise.prototype.then()</h2> <p><code>Promise</code> 实例具有 <code>then</code> 方法，也就是说，<code>then</code> 方法是定义在原型对象 Promise.prototype 上的。</p> <p>作用：为 <code>Promise</code> 实例添加状态改变时的回调函数</p> <p><code>then</code> 方法的第一个参数是 <code>resolved</code> 状态的回调函数，第二个参数是 <code>rejected</code> 状态的回调函数，它们都是可选的</p> <p><code>then</code> 方法返回的是一个新的 <code>Promise</code> 实例（注意，不是原来那个 <code>Promise</code> 实例）。</p> <p>因此可以采用链式写法，即 <code>then</code> 方法后面再调用另一个 <code>then</code> 方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;/posts.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> json<span class="token punctuation">.</span>post<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>第一个回调函数完成以后，会将返回结果作为参数，传入第二个回调函数。</p> <p>采用链式的 <code>then</code> ，可以指定一组按照次序调用的回调函数。</p> <p>前一个回调函数，有可能返回的还是一个 <code>Promise</code> 对象（即有异步操作），这时后一个回调函数，就会等待该 <code>Promise</code> 对象的状态发生变化，才会被调用。</p> <hr> <p><code>Promise</code>实例生成以后，可以用 <code>then</code> 方法分别指定 <code>resolved</code> 状态和 <code>rejected</code> 状态的回调函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// success</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// failure</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Promise</code> 实例的 <code>then</code> 方法，用来添加回调函数。</p> <p><code>then</code> 方法可以接受两个回调函数：</p> <ul><li>异步操作成功（变为 <code>fulfilled</code> 状态）时的回调函数</li> <li>异步操作失败（变为 <code>rejected</code> 状态）时的回调函数（该参数可以省略）</li></ul> <p>一旦状态改变，就调用相应的回调函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;成功&quot;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>‘失败’<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Error: 失败</span>
</code></pre></div><p>p1 和 p2 都是 <code>Promise</code> 实例，它们的 <code>then</code> 方法绑定两个回调函数：</p> <p>成功时的回调函数 console.log ，失败时的回调函数 console.error 。</p> <p>p1 的状态变为成功，p2 的状态变为失败，对应的回调函数会收到异步操作传回的值，然后在控制台输出</p> <p><code>then</code> 方法可以链式使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>p1
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step1<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step2<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>step3<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    console<span class="token punctuation">.</span>log<span class="token punctuation">,</span>
    console<span class="token punctuation">.</span>error
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>p1 后面有几个 <code>then</code> ，意味依次有几个回调函数。</p> <p>只要前一步的状态变为 <code>fulfilled</code> ，就会依次执行紧跟在后面的回调函数</p> <p>最后一个 <code>then</code> 方法，回调函数是 console.log 和 console.error ，用法上有一点重要的区别:</p> <p>console.log 只显示 step3 的返回值，而 console.error 可以显示 p1 、step1 、step2 、step3 之中任意一个发生的错误。</p> <p>如果 step1 的状态变为 <code>rejected</code> ，那么 step2 和 step3 都不会执行了（因为它们是 resolved 的回调函数）。</p> <p><code>Promise</code> 开始寻找，接下来第一个为 <code>rejected</code> 的回调函数，在上面代码中是 console.error</p> <p>∴ <code>Promise</code> 对象的报错具有传递性</p> <h2 id="promise-prototype-catch"><a href="#promise-prototype-catch" class="header-anchor">#</a> Promise.prototype.catch()</h2> <p><code>Promise.prototype.catch()</code> 方法是 <code>.then(null, rejection)</code> 或 <code>.then(undefined, rejection)</code> 的别名，用于指定发生错误时的回调函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">'/posts.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">posts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理 getJSON 和 前一个回调函数运行时发生的错误</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发生错误！'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>getJSON()</code> 方法返回一个 <code>Promise</code> 对象，如果该对象状态变为 <code>resolved</code> ，则会调用 <code>then()</code> 方法指定的回调函数；</p> <p>如果异步操作抛出错误，状态就会变为 <code>rejected</code> ，就会调用 <code>catch()</code> 方法指定的回调函数，处理这个错误</p> <p><code>then()</code> 方法指定的回调函数，如果运行中抛出错误，也会被 <code>catch()</code> 方法捕获</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fulfilled:'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fulfilled:'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;rejected:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="promise-prototype-finally"><a href="#promise-prototype-finally" class="header-anchor">#</a> Promise.prototype.finally()</h2> <p><code>finally()</code> 方法用于指定不管 <code>Promise</code> 对象最后状态如何，都会执行的操作</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>promise
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>···<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>···<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>···<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>不管 <code>promise</code> 最后的状态，在执行完 <code>then</code> 或 <code>catch</code> 指定的回调函数以后，都会执行 <code>finally</code> 方法指定的回调函数</p> <h3 id="服务器使用-promise-处理请求-然后使用-finally-方法关掉服务器"><a href="#服务器使用-promise-处理请求-然后使用-finally-方法关掉服务器" class="header-anchor">#</a> 服务器使用 <code>Promise</code> 处理请求，然后使用 <code>finally</code> 方法关掉服务器</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>stop<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>finally</code> 方法里面的操作，与状态无关的，不依赖于 <code>Promise</code> 的执行结果</p> <p><code>finally</code> 本质上是 <code>then</code> 方法的特例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>promise
<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 语句</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于</span>
promise
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 语句</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 语句</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果不使用 <code>finally</code> 方法，同样的语句需要为成功和失败两种情况各写一次。有了 <code>finally</code> 方法，则只需要写一次。</p> <h2 id="promise-all"><a href="#promise-all" class="header-anchor">#</a> Promise.all()</h2> <p><code>Promise.all()</code> 方法用于将多个 <code>Promise</code> 实例，包装成一个新的 <code>Promise</code> 实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Promise.all()</code> 方法接受一个数组作为参数，<code>p1</code>、<code>p2</code>、<code>p3</code>都是 <code>Promise</code> 实例，</p> <p>如果不是，就会先调用下面讲到的<code>Promise.resolve</code> 方法，将参数转为 <code>Promise</code> 实例，再进一步处理</p> <p><code>Promise.all()</code> 方法的参数可以不是数组，但必须具有 <code>Iterator</code> (迭代器)接口，且返回的每个成员都是 <code>Promise</code> 实例</p> <p><code>p</code> 的状态由 <code>p1</code> 、 <code>p2</code> 、 <code>p3</code> 决定，分成两种情况</p> <ul><li><p>只有 <code>p1</code> 、 <code>p2</code> 、 <code>p3</code> 的状态都变成 <code>fulfilled</code> ， <code>p</code> 的状态才会变成 <code>fulfilled</code> ，此时 <code>p1</code> 、 <code>p2</code> 、 <code>p3</code> 的返回值组成一个数组，传递给p的回调函数。</p></li> <li><p>只要 <code>p1</code> 、 <code>p2</code> 、 <code>p3</code> 之中有一个被 <code>rejected</code> ， <code>p</code> 的状态就变成 <code>rejected</code> ，此时第一个被 <code>reject</code> 的实例的返回值，会传递给 <code>p</code> 的回调函数。</p></li></ul> <h2 id="promise-race"><a href="#promise-race" class="header-anchor">#</a> Promise.race()</h2> <p><code>Promise.race()</code> 方法将多个 <code>Promise</code> 实例，包装成一个新的 <code>Promise</code> 实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>只要 <code>p1</code> 、 <code>p2</code> 、 <code>p3</code> 之中有一个实例率先改变状态，p的状态就跟着改变。那个率先改变的 <code>Promise</code> 实例的返回值，就传递给 <code>p</code> 的回调函数</p> <h3 id="如果指定时间内没有获得结果-就将-promise-的状态变为-reject-否则变为-resolve"><a href="#如果指定时间内没有获得结果-就将-promise-的状态变为-reject-否则变为-resolve" class="header-anchor">#</a> 如果指定时间内没有获得结果，就将 <code>Promise</code> 的状态变为 <code>reject</code> ，否则变为 <code>resolve</code></h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/resource-that-may-take-a-while'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'request timeout'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果 5 秒之内 <code>fetch</code> 方法无法返回结果，变量 <code>p</code> 的状态就会变为 <code>rejected</code> ，从而触发 <code>catch</code> 方法指定的回调函数</p> <h2 id="promise-allsettled"><a href="#promise-allsettled" class="header-anchor">#</a> Promise.allSettled()</h2> <p><code>Promise.all()</code> 方法只适合所有异步操作都成功的情况，如果有一个操作失败，就无法满足要求。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span>url_1<span class="token punctuation">,</span> url_2<span class="token punctuation">,</span> url_3<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> requests <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token function">fetch</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有请求都成功。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'至少一个请求失败，其他请求可能还没结束。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Promise.all()</code> 可以确定所有请求都成功了，但是只要有一个请求失败，它就会报错，而不管另外的请求是否结束。</p> <p><code>Promise.allSettled()</code> 方法，用来确定一组异步操作是否都结束了（不管成功或失败）。</p> <p><code>Settled</code> 包含了 <code>fulfilled</code> 和 <code>rejected</code> 两种情况。</p> <p><code>Promise.allSettled()</code> 方法接受一个数组作为参数，数组的每个成员都是一个 <code>Promise</code> 对象，并返回一个新的 <code>Promise</code> 对象。</p> <p>只有等到参数数组的所有 <code>Promise</code> 对象都发生状态变更（不管是 <code>fulfilled</code> 还是 <code>rejected</code> ），返回的 <code>Promise</code> 对象才会发生状态变更。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api-1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api-2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api-3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">allSettled</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">removeLoadingIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>数组 <code>promises</code> 包含了三个请求，只有等到这三个请求都结束了（不管请求成功还是失败）， <code>removeLoadingIndicator()</code> 才会执行</p> <p>该方法返回的新的 <code>Promise</code> 实例，一旦发生状态变更，状态总是 <code>fulfilled</code> ，不会变成 <code>rejected</code> 。</p> <p>状态变成 <code>fulfilled</code> 后，它的回调函数会接收到一个数组作为参数，该数组的每个成员对应前面数组的每个 <code>Promise</code> 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> resolved <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rejected <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> allSettledPromise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">allSettled</span><span class="token punctuation">(</span><span class="token punctuation">[</span>resolved<span class="token punctuation">,</span> rejected<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

allSettledPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [</span>
<span class="token comment">//    { status: 'fulfilled', value: 42 },</span>
<span class="token comment">//    { status: 'rejected', reason: -1 }</span>
<span class="token comment">// ]</span>
</code></pre></div><p><code>Promise.allSettled()</code> 的返回值 <code>allSettledPromise</code> ，状态只可能变成 <code>fulfilled</code> 。</p> <p>它的回调函数接收到的参数是数组 <code>results</code> 。</p> <p>该数组的每个成员都是一个对象，对应传入 <code>Promise.allSettled()</code> 的数组里面的两个 <code>Promise</code> 对象</p> <p>results的每个成员是一个对象，对象的格式是固定的，对应异步操作的结果。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 异步操作成功时</span>
<span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'fulfilled'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">}</span>

<span class="token comment">// 异步操作失败时</span>
<span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'rejected'</span><span class="token punctuation">,</span> <span class="token literal-property property">reason</span><span class="token operator">:</span> reason<span class="token punctuation">}</span>
</code></pre></div><p>成员对象的 <code>status</code> 属性的值只可能是字符串 <code>fulfilled</code> 或字符串 <code>rejected</code> ，用来区分异步操作是成功还是失败。</p> <p>如果是成功（<code>fulfilled</code>），对象会有 <code>value</code> 属性，如果是失败（<code>rejected</code>），会有 <code>reason</code> 属性，对应两种状态时前面异步操作的返回值</p> <h2 id="promise-any"><a href="#promise-any" class="header-anchor">#</a> Promise.any()</h2> <p>接受一组 <code>Promise</code> 实例作为参数，包装成一个新的 <code>Promise</code> 实例返回</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://v8.dev/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://v8.dev/blog'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'blog'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://v8.dev/docs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'docs'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">first</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 只要有一个 fetch() 请求成功</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 所有三个 fetch() 全部请求失败</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>只要参数实例有一个变成 <code>fulfilled</code> 状态，包装实例就会变成 <code>fulfilled</code> 状态；</p> <p>如果所有参数实例都变成 <code>rejected</code> 状态，包装实例就会变成 <code>rejected</code> 状态。</p> <p><code>Promise.any()</code> 不会因为某个 <code>Promise</code> 变成 <code>rejected</code> 状态而结束，</p> <p>必须等到所有参数 <code>Promise</code> 变成 <code>rejected</code> 状态才会结束。</p> <h3 id="promise-与-await-命令结合"><a href="#promise-与-await-命令结合" class="header-anchor">#</a> <code>Promise()</code> 与 <code>await</code> 命令结合</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/endpoint-a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/endpoint-b'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/endpoint-c'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> first <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Promise.any()</code> 方法的参数数组包含三个 <code>Promise</code> 操作。</p> <p>其中只要有一个变成 <code>fulfilled</code> ，<code>Promise.any()</code> 返回的 <code>Promise</code> 对象就变成 <code>fulfilled</code> 。</p> <p>如果所有三个操作都变成 <code>rejected</code> ，那么 <code>await</code> 命令就会抛出错误</p> <h2 id="promise-resolve"><a href="#promise-resolve" class="header-anchor">#</a> Promise.resolve()</h2> <p>将现有对象转为 <code>Promise</code> 对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 将 jQuery 生成的 deferred 对象，转为一个新的 Promise 对象</span>
<span class="token keyword">const</span> jsPromise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'/whatever.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token comment">// 等价于</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="参数是一个-promise-实例"><a href="#参数是一个-promise-实例" class="header-anchor">#</a> 参数是一个 Promise 实例</h3> <p><code>Promise.resolve</code> 将不做任何修改、原封不动地返回这个实例</p> <h3 id="参数是一个-thenable-对象"><a href="#参数是一个-thenable-对象" class="header-anchor">#</a> 参数是一个 <code>thenable</code> 对象</h3> <p><code>thenable</code> 对象指的是具有 <code>then</code> 方法的对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Promise.resolve()</code> 方法会将这个对象转为 <code>Promise</code> 对象，然后就立即执行 <code>thenable</code> 对象的 <code>then()</code> 方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 42</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>thenable</code> 对象的 <code>then()</code> 方法执行后，对象 <code>p1</code> 的状态就变为 <code>resolved</code> ，</p> <p>从而立即执行最后那个 <code>then()</code> 方法指定的回调函数，输出 42</p> <h3 id="参数不是具有-then-方法的对象-或根本就不是对象"><a href="#参数不是具有-then-方法的对象-或根本就不是对象" class="header-anchor">#</a> 参数不是具有 <code>then()</code> 方法的对象，或根本就不是对象</h3> <p>如果参数是一个原始值，或者是一个不具有 <code>then()</code> 方法的对象，</p> <p>则 <code>Promise.resolve()</code> 方法返回一个新的 <code>Promise</code> 对象，状态为 <code>resolved</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Hello</span>
</code></pre></div><p>新的 <code>Promise</code> 对象的实例 <code>p</code>。</p> <p>字符串 <code>Hello</code> 不属于异步操作（字符串对象不具有 <code>then</code> 方法）</p> <p>返回 <code>Promise</code> 实例的状态从一生成就是 <code>resolved</code> ，所以回调函数会立即执行。</p> <p><code>Promise.resolve()</code> 方法的参数，会同时传给回调函数。</p> <h3 id="不带有任何参数"><a href="#不带有任何参数" class="header-anchor">#</a> 不带有任何参数</h3> <p><code>Promise.resolve()</code> 方法允许调用时不带参数，直接返回一个 <code>resolved</code> 状态的 <code>Promise</code> 对象。</p> <p>直接调用 <code>Promise.resolve()</code>方法，得到一个 <code>Promise</code> 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>变量 <code>p</code> 是一个 <code>Promise</code> 对象</p> <p>立即 <code>resolve()</code> 的 <code>Promise</code> 对象，是在本轮'事件循环'（<code>event loop</code>）的结束时执行，而不是在下一轮'事件循环'的开始时</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// one</span>
<span class="token comment">// two</span>
<span class="token comment">// three</span>
</code></pre></div><p><code>setTimeout(fn, 0)</code> 在下一轮'事件循环'开始时执行</p> <p><code>Promise.resolve()</code> 在本轮'事件循环'结束时执行</p> <p><code>console.log('one')</code> 是立即执行，因此最先输出</p> <h2 id="promise-reject"><a href="#promise-reject" class="header-anchor">#</a> Promise.reject()</h2> <p>返回一个新的 <code>Promise</code> 实例，该实例的状态为 <code>rejected</code> (操作失败)</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 等同于</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 出错了</span>
</code></pre></div><p>生成一个 <code>Promise</code> 对象的实例 <code>p</code> ，状态为 <code>rejected</code> ，回调函数会立即执行。</p> <p><code>Promise.reject()</code> 方法的参数，会原封不动地作为 <code>reject</code> 的理由，变成后续方法的参数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e <span class="token operator">===</span> <span class="token string">'出错了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// true</span>
</code></pre></div><p><code>Promise.reject()</code> 方法的参数是一个字符串，后面 <code>catch()</code> 方法的参数 <code>e</code> 就是这个字符串</p> <h2 id="promise-try"><a href="#promise-try" class="header-anchor">#</a> Promise.try()</h2> <p>不管 <code>f</code> 是否包含异步操作，都用 <code>then</code> 方法指定下一步流程，用 <code>catch</code> 方法处理 <code>f</code> 抛出的错误</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
</code></pre></div><p>如果 <code>f</code> 是同步函数，那么它会在本轮事件循环的末尾执行</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// next</span>
<span class="token comment">// now</span>
</code></pre></div><p>函数 <code>f</code> 是同步的，但是用 <code>Promise</code> 包装了以后，就变成异步执行了</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blogs/tools/optimize.html" class="prev">
        优化
      </a></span> <span class="next"><a href="/blogs/tools/report errors.html">
        报错
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blogs/assets/js/app.ce7ede7b.js" defer></script><script src="/blogs/assets/js/2.487b4d99.js" defer></script><script src="/blogs/assets/js/45.1caf120e.js" defer></script>
  </body>
</html>
