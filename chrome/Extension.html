<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>chrome 扩展程序（插件） | Kaino·Lamperouge</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.539e4251.css" as="style"><link rel="preload" href="/blogs/assets/js/app.ce7ede7b.js" as="script"><link rel="preload" href="/blogs/assets/js/2.487b4d99.js" as="script"><link rel="preload" href="/blogs/assets/js/15.33dd3631.js" as="script"><link rel="prefetch" href="/blogs/assets/js/10.80cbf96f.js"><link rel="prefetch" href="/blogs/assets/js/11.c45194b4.js"><link rel="prefetch" href="/blogs/assets/js/12.2efdb192.js"><link rel="prefetch" href="/blogs/assets/js/13.10b60b19.js"><link rel="prefetch" href="/blogs/assets/js/14.6f5ffd95.js"><link rel="prefetch" href="/blogs/assets/js/16.153c9f54.js"><link rel="prefetch" href="/blogs/assets/js/17.d3d13da0.js"><link rel="prefetch" href="/blogs/assets/js/18.7f596757.js"><link rel="prefetch" href="/blogs/assets/js/19.d3a2e782.js"><link rel="prefetch" href="/blogs/assets/js/20.77743e4c.js"><link rel="prefetch" href="/blogs/assets/js/21.a30af7e4.js"><link rel="prefetch" href="/blogs/assets/js/22.c0f4dfd0.js"><link rel="prefetch" href="/blogs/assets/js/23.e9479e63.js"><link rel="prefetch" href="/blogs/assets/js/24.b988021c.js"><link rel="prefetch" href="/blogs/assets/js/25.e4ad174d.js"><link rel="prefetch" href="/blogs/assets/js/26.bafad003.js"><link rel="prefetch" href="/blogs/assets/js/27.9249910c.js"><link rel="prefetch" href="/blogs/assets/js/28.950707e6.js"><link rel="prefetch" href="/blogs/assets/js/29.bf869df0.js"><link rel="prefetch" href="/blogs/assets/js/3.e528ebb8.js"><link rel="prefetch" href="/blogs/assets/js/30.b031c849.js"><link rel="prefetch" href="/blogs/assets/js/31.5400d7fb.js"><link rel="prefetch" href="/blogs/assets/js/32.c115fe94.js"><link rel="prefetch" href="/blogs/assets/js/33.a59460b4.js"><link rel="prefetch" href="/blogs/assets/js/34.58791948.js"><link rel="prefetch" href="/blogs/assets/js/35.9827412c.js"><link rel="prefetch" href="/blogs/assets/js/36.fcd58bb9.js"><link rel="prefetch" href="/blogs/assets/js/37.9e8b88c2.js"><link rel="prefetch" href="/blogs/assets/js/38.ec287719.js"><link rel="prefetch" href="/blogs/assets/js/39.a6c2817d.js"><link rel="prefetch" href="/blogs/assets/js/4.bb4a3f3b.js"><link rel="prefetch" href="/blogs/assets/js/40.a9735c86.js"><link rel="prefetch" href="/blogs/assets/js/41.cd113c63.js"><link rel="prefetch" href="/blogs/assets/js/42.d905a84f.js"><link rel="prefetch" href="/blogs/assets/js/43.af91aceb.js"><link rel="prefetch" href="/blogs/assets/js/44.3223b301.js"><link rel="prefetch" href="/blogs/assets/js/45.1caf120e.js"><link rel="prefetch" href="/blogs/assets/js/46.87734e69.js"><link rel="prefetch" href="/blogs/assets/js/47.ba0da5fa.js"><link rel="prefetch" href="/blogs/assets/js/48.4bcb31ac.js"><link rel="prefetch" href="/blogs/assets/js/49.3326df5f.js"><link rel="prefetch" href="/blogs/assets/js/5.78e26efb.js"><link rel="prefetch" href="/blogs/assets/js/50.7b0acd87.js"><link rel="prefetch" href="/blogs/assets/js/51.5497ff88.js"><link rel="prefetch" href="/blogs/assets/js/52.48607488.js"><link rel="prefetch" href="/blogs/assets/js/53.9ce906eb.js"><link rel="prefetch" href="/blogs/assets/js/54.23ef8813.js"><link rel="prefetch" href="/blogs/assets/js/6.94f35d6d.js"><link rel="prefetch" href="/blogs/assets/js/7.91a26545.js"><link rel="prefetch" href="/blogs/assets/js/8.11b78e3f.js"><link rel="prefetch" href="/blogs/assets/js/9.80035b18.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.539e4251.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><!----> <span class="site-name">Kaino·Lamperouge</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Canvas" class="dropdown-title"><span class="title">Canvas</span> <span class="arrow down"></span></button> <button type="button" aria-label="Canvas" class="mobile-dropdown-title"><span class="title">Canvas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/canvas/Canvas.html" class="nav-link">
  Canvas
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/OpenGL.html" class="nav-link">
  GLSL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/Three.js.html" class="nav-link">
  Three.js
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGL.html" class="nav-link">
  WebGL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGLProgram.html" class="nav-link">
  WebGLProgram
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Chrome" class="dropdown-title"><span class="title">Chrome</span> <span class="arrow down"></span></button> <button type="button" aria-label="Chrome" class="mobile-dropdown-title"><span class="title">Chrome</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/chrome/Extension.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  扩展
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="uni-app" class="dropdown-title"><span class="title">uni-app</span> <span class="arrow down"></span></button> <button type="button" aria-label="uni-app" class="mobile-dropdown-title"><span class="title">uni-app</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/uniapp/import.html" class="nav-link">
  引用
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/CSS.html" class="nav-link">
  CSS 变量
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/modifier.html" class="nav-link">
  事件修饰符
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/component.html" class="nav-link">
  组件
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/python/Underline.html" class="nav-link">
  下划线
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MiniProject" class="dropdown-title"><span class="title">MiniProject</span> <span class="arrow down"></span></button> <button type="button" aria-label="MiniProject" class="mobile-dropdown-title"><span class="title">MiniProject</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Timer.html" class="nav-link">
  计时器
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Demo.html" class="nav-link">
  demo
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Batch.html" class="nav-link">
  批量删除
</a></li></ul></div></div><div class="nav-item"><a href="/blogs/about/" class="nav-link">
  About
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Canvas" class="dropdown-title"><span class="title">Canvas</span> <span class="arrow down"></span></button> <button type="button" aria-label="Canvas" class="mobile-dropdown-title"><span class="title">Canvas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/canvas/Canvas.html" class="nav-link">
  Canvas
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/OpenGL.html" class="nav-link">
  GLSL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/Three.js.html" class="nav-link">
  Three.js
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGL.html" class="nav-link">
  WebGL
</a></li><li class="dropdown-item"><!----> <a href="/blogs/canvas/WebGLProgram.html" class="nav-link">
  WebGLProgram
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Chrome" class="dropdown-title"><span class="title">Chrome</span> <span class="arrow down"></span></button> <button type="button" aria-label="Chrome" class="mobile-dropdown-title"><span class="title">Chrome</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/chrome/Extension.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  扩展
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="uni-app" class="dropdown-title"><span class="title">uni-app</span> <span class="arrow down"></span></button> <button type="button" aria-label="uni-app" class="mobile-dropdown-title"><span class="title">uni-app</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/uniapp/import.html" class="nav-link">
  引用
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/CSS.html" class="nav-link">
  CSS 变量
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/modifier.html" class="nav-link">
  事件修饰符
</a></li><li class="dropdown-item"><!----> <a href="/blogs/uniapp/component.html" class="nav-link">
  组件
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/python/Underline.html" class="nav-link">
  下划线
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MiniProject" class="dropdown-title"><span class="title">MiniProject</span> <span class="arrow down"></span></button> <button type="button" aria-label="MiniProject" class="mobile-dropdown-title"><span class="title">MiniProject</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Timer.html" class="nav-link">
  计时器
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Demo.html" class="nav-link">
  demo
</a></li><li class="dropdown-item"><!----> <a href="/blogs/miniproject/Batch.html" class="nav-link">
  批量删除
</a></li></ul></div></div><div class="nav-item"><a href="/blogs/about/" class="nav-link">
  About
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blogs/" class="sidebar-heading clickable router-link-active open"><span>Tools</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/tools/CSS/animation.html" class="sidebar-link">animation</a></li><li><a href="/blogs/tools/CSS/keyframes.html" class="sidebar-link">@keyframes</a></li><li><a href="/blogs/tools/JavaScript/copy.html" class="sidebar-link">浅拷贝深拷贝</a></li><li><a href="/blogs/tools/JavaScript/cursor.html" class="sidebar-link">更改鼠标指针</a></li><li><a href="/blogs/tools/JavaScript/event.html" class="sidebar-link">事件流</a></li><li><a href="/blogs/tools/JavaScript/export.html" class="sidebar-link">Export</a></li><li><a href="/blogs/tools/JavaScript/grammar.html" class="sidebar-link">Grammar</a></li><li><a href="/blogs/tools/JavaScript/object.html" class="sidebar-link">Object</a></li><li><a href="/blogs/tools/JavaScript/void.html" class="sidebar-link">Void</a></li><li><a href="/blogs/tools/Business Consumer.html" class="sidebar-link">B端C端</a></li><li><a href="/blogs/tools/closure.html" class="sidebar-link">闭包</a></li><li><a href="/blogs/tools/css preprocessor.html" class="sidebar-link">Css预处理器</a></li><li><a href="/blogs/tools/debounce throttle.html" class="sidebar-link">防抖和节流</a></li><li><a href="/blogs/tools/debugger.html" class="sidebar-link">断点调试</a></li><li><a href="/blogs/tools/hook.html" class="sidebar-link">钩子函数</a></li><li><a href="/blogs/tools/git.html" class="sidebar-link">Git</a></li><li><a href="/blogs/tools/Low Code.html" class="sidebar-link">低代码</a></li><li><a href="/blogs/tools/markdown.html" class="sidebar-link">md语法</a></li><li><a href="/blogs/tools/Memory Leak.html" class="sidebar-link">内存泄漏</a></li><li><a href="/blogs/tools/MVC.html" class="sidebar-link">MVC</a></li><li><a href="/blogs/tools/MVVM.html" class="sidebar-link">MVVM</a></li><li><a href="/blogs/tools/npm.html" class="sidebar-link">NPM</a></li><li><a href="/blogs/tools/optimize.html" class="sidebar-link">优化</a></li><li><a href="/blogs/tools/promise.html" class="sidebar-link">Promise</a></li><li><a href="/blogs/tools/report errors.html" class="sidebar-link">报错</a></li><li><a href="/blogs/tools/shell.html" class="sidebar-link">Shell</a></li><li><a href="/blogs/tools/style.html" class="sidebar-link">Style</a></li><li><a href="/blogs/tools/timestamp.html" class="sidebar-link">时间戳</a></li><li><a href="/blogs/tools/URL Code.html" class="sidebar-link">URL编码</a></li><li><a href="/blogs/tools/URL Transfer Parameters.html" class="sidebar-link">URL携带参数缺失</a></li><li><a href="/blogs/tools/uuid.html" class="sidebar-link">UUID</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chrome-扩展程序-插件"><a href="#chrome-扩展程序-插件" class="header-anchor">#</a> chrome 扩展程序（插件）</h1> <h2 id="插件构成"><a href="#插件构成" class="header-anchor">#</a> 插件构成</h2> <p><strong>manifest.json</strong>：相当于插件的 <code>meta</code> 信息，包含插件的名称、版本号、图标、脚本文件名称等，这个文件是每个插件都必须提供的，其他几部分都是可选的。
<strong>background script</strong>：可以调用全部的 <code>chrome</code> 插件 <code>API</code> ，实现跨域请求、网页截屏、弹出 <code>chrome</code> 通知消息等功能。相当于在一个隐藏的浏览器页面内默默运行。
<strong>功能页面</strong>：包括点击插件图标弹出的页面（简称 <code>popup</code> ）、插件的配置页面（简称 <code>options</code> ）。
<strong>content script</strong>：早期也被称为 <code>injected script</code> ，是插件注入到页面的脚本，但是不会体现在页面 <code>DOM</code> 结构里。<code>content script</code> 可以操作 <code>DOM</code> ，但是它和页面其他的脚本是隔离的，访问不到其他脚本定义的变量、函数等，相当于运行在单独的沙盒里。<code>content script</code> 可以调用有限的 <code>chrome</code> 插件 <code>API</code> ，网络请求收到同源策略限制。</p> <h3 id="manifest-json"><a href="#manifest-json" class="header-anchor">#</a> manifest.json</h3> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// 必须</span>
  <span class="token property">&quot;manifest_version&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;插件名称a&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.1.2&quot;</span><span class="token punctuation">,</span>

  <span class="token comment">// 推荐</span>
  <span class="token property">&quot;default_locale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;en&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;插件的描述&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;img/icon.png&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 扩展程序页面上的图标</span>
    <span class="token property">&quot;32&quot;</span><span class="token operator">:</span> <span class="token string">&quot;img/icon.png&quot;</span><span class="token punctuation">,</span> <span class="token comment">// Windows计算机通常需要此大小。提供此选项可防止尺寸失真缩小48x48选项。</span>
    <span class="token property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;img/icon.png&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 显示在扩展程序管理页面上</span>
    <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;img/icon.png&quot;</span> <span class="token comment">// 在安装和Chrome Webstore中显示</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 可选</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;background/background.html&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;background.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 推荐</span>
    <span class="token property">&quot;persistent&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;browser_action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;img/icon.png&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 特定于工具栏的图标，至少建议使用16x16和32x32尺寸，应为方形，</span>
    <span class="token comment">// 不然会变形</span>
    <span class="token property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;悬浮在工具栏插件图标上时的tooltip内容&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hello.html&quot;</span> <span class="token comment">// 不允许内联JavaScript。</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content_scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;inject.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://*/*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://*/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;run_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;document_start&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;contextMenus&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tabs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://*/*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://*/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;web_accessible_resources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dist/*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dist/**/*&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="icons"><a href="#icons" class="header-anchor">#</a> icons</h4> <p><code>extension</code> 程序的图标，可以有一个或多个。</p> <p><code>48x48</code> 的图标用在 <code>extensions</code> 的管理界面(<code>chrome://extensions</code>)</p> <p><code>128x128</code> 的图标用在安装 <code>extension</code> 程序的时候</p> <p><code>16x16</code> 的图标当作 <code>extension</code> 的页面图标，也可以显示在信息栏上</p> <p>图标一般为 <code>PNG</code> 格式, 因为最好的透明度的支持，不过 <code>WebKit</code> 支持任何格式，包括 <code>BMP</code> ，<code>GIF</code> ，<code>ICO</code> 等</p> <p>注意: 以上写的图标不是固定的。随浏览器的环境的改变而变。如：安装时弹出的对话框变小。</p> <h4 id="browser-action-与-page-action"><a href="#browser-action-与-page-action" class="header-anchor">#</a> browser_action 与 page_action</h4> <p><code>browser_action</code> 可以适用于任何页面</p> <p><code>page_action</code> 只能作用于某一页面，当打开该页面时触发该 <code>Google Chrome</code> 扩展，关闭页面则 <code>Google Chrome</code> 扩展也随之消失</p> <p>一些扩展任何页面可用，就都会显示在工具栏上为可用状态，一些扩展只适用于某些页面，如大家很熟悉的 <code>vue tools</code> 调试器，在检测到页面用的是 <code>vue</code> 时，就会在工具栏显示出来并可用（非灰色）</p> <h4 id="default-popup"><a href="#default-popup" class="header-anchor">#</a> default_popup</h4> <p>在用户点击扩展程序图标时，都可以设置弹出一个 <code>popup</code> 页面。而这个页面中有可以运行的 <code>js</code> 脚本的。它会在每次点击插件图标—— <code>popup</code> 页面弹出时，重新载入。</p> <h4 id="permissions"><a href="#permissions" class="header-anchor">#</a> permissions</h4> <p>在 <code>background</code> 里使用一些 <code>chrome api</code> ，需要授权才能使用，例如要使用 <code>chrome.tabs.xxx</code> 的 <code>api</code> ，就要在 <code>permissions</code> 引入“<code>tabs</code>”</p> <h4 id="web-accessible-resources"><a href="#web-accessible-resources" class="header-anchor">#</a> web_accessible_resources</h4> <p>允许扩展外的页面访问的扩展内指定的资源。扩展是一个文件夹 <code>A</code> 的，别人的网站是一个文件夹 <code>B</code> ，<code>B</code> 要看 <code>A</code> 的东西，需要获得权限，而写在这个属性下的文件，就是授予了别人访问的权限。</p> <h3 id="background-script"><a href="#background-script" class="header-anchor">#</a> background script</h3> <p><code>background</code> 可以理解为插件运行在浏览器中的一个后台网站/脚本，它是与当前浏览页面无关的。</p> <p>实际上这部分内容的配置情况也会写在 <code>manifest</code> 里，对应的是 <code>background</code> 配置项。</p> <h4 id="page"><a href="#page" class="header-anchor">#</a> page</h4> <p>这个后台网站的主页，在这个主页中，有引用的脚本，其中一般都会有一个专门来管理插件各种交互以及监听浏览器行为的脚本，一般都起名为 <code>background.js</code>。这个主页，不一定要求有。</p> <h4 id="scripts"><a href="#scripts" class="header-anchor">#</a> scripts</h4> <p><code>page</code> 的 <code>html</code> 在没有的情况下，那么脚本就需要通过这个属性引入了；
如果在存在 <code>page</code> 的情况下，一般在这里引入的脚本是专门为插件服务的脚本，而那些第三方脚本如 <code>jquery</code> 还是在 <code>page</code> 里引用比较好</p> <h4 id="persistent"><a href="#persistent" class="header-anchor">#</a> persistent</h4> <p>后台脚本，在 <code>chrome</code> 扩展中又分为两类，分别运行于后台页面（ <code>background page</code> ）和事件页面（ <code>event page</code> ）中。</p> <p>前者（后台页面）持续运行，生存周期和浏览器相同，即从打开浏览器到关闭浏览器期间，后台脚本一直在运行，一直占据着内存等系统资源， <code>persistent</code> 设为 <code>true</code> ；</p> <p>后者（事件页面）只在需要活动时活动，在完全不活动的状态持续几秒后，<code>chrome</code> 将会终止其运行，从而释放其占据的系统资源，而在再次有事件需要后台脚本来处理时，重新载入它，<code>persistent</code> 设为 <code>false</code> 。</p> <p>保持后台脚本持久活动的唯一场合是扩展使用 <code>chrome.webRequest API</code> 来阻止或修改网络请求。
<code>webRequest API</code> 与非持久性后台页面不兼容。</p> <h3 id="content-script"><a href="#content-script" class="header-anchor">#</a> content script</h3> <p>插入到网页中的脚本。它具有独立而富有包容性。</p> <p>独立，指它的工作空间，命名空间，域等是独立的，不会说跟插入到的页面的某些函数和变量发生冲突；</p> <p>包容性，指插件把自己的一些脚本（ <code>content script</code> ）插入到符合条件的页面里，作为页面的脚本，因此与插入的页面共享 <code>dom</code> 的，即用 <code>dom</code> 操作是针对插入的网页的，在这些脚本里使用的 <code>window</code> 对象跟插入页面的 <code>window</code> 是一样的。主要用在消息传递上（使用 <code>postMessage</code> 和 <code>onmessage</code> ）</p> <h4 id="js"><a href="#js" class="header-anchor">#</a> js</h4> <p>要插入到页面里的脚本。</p> <h4 id="matches"><a href="#matches" class="header-anchor">#</a> matches</h4> <p>必需。匹配规则组成的数组，用来匹配页面 <code>url</code> 的，符合条件的页面将会插入 <code>js</code> 的脚本。当然，有可以匹配的自然会有不匹配的—— <code>exclude_matches</code> 。</p> <p>匹配规则：</p> <p><a href="https://developer.chrome.com/extensions/match_patterns" target="_blank" rel="noopener noreferrer">developer.chrome.com/extensions/…<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="run-at"><a href="#run-at" class="header-anchor">#</a> run_at</h4> <p>这三个配置项来控制 <code>js</code> 配置项里的脚本插入页面的时机。</p> <ul><li>document_start</li> <li>document_end</li> <li>document_idle（默认）</li></ul> <p><strong>document_start：</strong></p> <p><code>style</code> 样式加载好，<code>dom</code> 渲染完成和脚本执行前</p> <p><strong>document_end：</strong></p> <p><code>dom</code> 渲染完成后，即 <code>DOMContentLoaded</code> 后马上执行</p> <p><strong>document_idle：</strong></p> <p>在 <code>DOMContentLoaded</code> 和 <code>window load</code> 之间，具体是什么时刻，要视页面的复杂程度和加载时间，并针对页面加载速度进行了优化。</p> <h3 id="popup"><a href="#popup" class="header-anchor">#</a> popup</h3> <p>在 <code>manifest</code> 里的 <code>browser_action</code> 与 <code>page_action</code> 配置项里设置的</p> <h2 id="通信机制"><a href="#通信机制" class="header-anchor">#</a> 通信机制</h2> <h3 id="content-script-与-background-的通信通信机制"><a href="#content-script-与-background-的通信通信机制" class="header-anchor">#</a> <code>content script</code> 与 <code>background</code> 的通信通信机制</h3> <h4 id="content-script-向-background-发送消息"><a href="#content-script-向-background-发送消息" class="header-anchor">#</a> <code>content-script</code> 向 <code>background</code> 发送消息</h4> <p><strong>在 content-script 端：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessege</span><span class="token punctuation">(</span>
    message<span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>就能向 <code>background</code> 发送消息了，第一个参数 <code>message</code> 为发送的消息（基础数据类型），回调函数里的第一个参数为 <code>background</code> 接收消息后返回的消息（如有）</p> <p><strong>在 background 端：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessege<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>进行监听发来的消息，<code>request</code> 表示发来的消息，<code>sendResponse</code> 是一个函数，用于对发来的消息进行回应，
如: sendResponse('我已收到你的消息：'+ JSON.stringify(request));</p> <p>默认情况下 <code>sendResponse</code> 函数的执行是同步的，如果在这个监听消息的处理函数的同步执行流程里没有发现 <code>sendResponse</code> ，则默认返回 <code>undefined</code></p> <p>异步执行 <code>sendResponse</code> 时，我们在这个监听函数里的添加 <code>return true</code> 就能实现了。
由于 <code>background</code> 监听所有页面上的 <code>content script</code> 上发来的消息，如果多个页面同时发送同种消息，<code>background</code> 的 <code>onMessage</code> 只会处理最先收到的那个。</p> <h4 id="background-向-content-script-发送消息"><a href="#background-向-content-script-发送消息" class="header-anchor">#</a> <code>background</code> 向 <code>content-script</code> 发送消息</h4> <p>一个插件里只有一个 <code>background</code> 环境，而 <code>content-script</code> 有多个（一个页面一个），那么 <code>background</code> 怎么向特定的 <code>content-script</code> 发送消息？</p> <p><strong>在 background 端：</strong></p> <p>一般一个页面一份 <code>content scripts</code>，而一个页面对应一个浏览器 <code>tab</code> ，每个 <code>tab</code> 都有自己的 <code>tabId</code> ，因此首先要获取要发送消息的 <code>tab</code> 对应的 <code>tabId</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 获取当前选项卡id
 * @param callback - 获取到id后要执行的回调函数
 */</span>
<span class="token keyword">function</span> <span class="token function">getCurrentTabId</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">currentWindow</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tabs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>tabs<span class="token punctuation">.</span>length <span class="token operator">?</span> tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当知道了 <code>tabId</code> 后，就使用该 <code>api</code> 进行发送消息</p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tabId<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>message</code> 为发送的消息，回调函数的 <code>response</code> 为 <code>content scripts</code> 接收到消息后的回传消息</p> <p><strong>在 content-script 端：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessege<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>进行来自 <code>background</code> 发来消息的监听并回传</p> <h3 id="popup-与-background-的通信"><a href="#popup-与-background-的通信" class="header-anchor">#</a> <code>popup</code> 与 <code>background</code> 的通信</h3> <p><code>popup</code> 与 <code>background</code> 的交流，常见于 <code>popup</code> 要获取 <code>background</code> 里的某些“东西”</p> <p>使用上述的 <code>chrome.runtime.sendMessage</code> 和 <code>chrome.runtime.onMessage</code> 的方式进行 <code>popup</code> 向 <code>background</code> 的交流，但是其实有更方便快捷的方式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> bg <span class="token operator">=</span> chrome<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token function">getBackgroundPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bg<span class="token punctuation">.</span><span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//someMethod()是background中的一个方法</span>
</code></pre></div><h3 id="popup-与-content-script-的通信"><a href="#popup-与-content-script-的通信" class="header-anchor">#</a> <code>popup</code> 与 <code>content script</code> 的通信</h3> <p>跟 background 与 content script 的方式是一样的</p> <h3 id="插件-iframe-网站与插入网页的通信"><a href="#插件-iframe-网站与插入网页的通信" class="header-anchor">#</a> 插件 <code>iframe</code> 网站与插入网页的通信</h3> <p><code>ifame</code> 与父窗体的通信</p> <p>同域的情况下，可以通过 <code>DOM</code> 操作达到通信的目的，如获取 <code>dom</code> 元素，获取值赋值之类的。</p> <p>在父窗体里，用 <code>window.contentWindow</code> 获取到 <code>iframe</code> 的 <code>window</code> 对象</p> <p>在 <code>iframe</code> 里，用 <code>window.parent</code> 获取到父窗体的 <code>window</code> 对象</p> <p>在跨域下，插件，最方便的就是使用 <code>js</code> 的 <code>message</code> 机制了：使用 <code>window</code> 对象的 <code>postMessage()</code> 和 <code>onmessage</code> 。</p> <h4 id="iframe-向父窗体发送消息"><a href="#iframe-向父窗体发送消息" class="header-anchor">#</a> <code>iframe</code> 向父窗体发送消息</h4> <p><strong>在 iframe 端：</strong></p> <p><code>iframe</code> 是 <code>HTML</code> 中的一个标签，全称为&quot;<code>inline frame</code>&quot;，意为内联框架。它可以在网页中嵌入其他网页或文档，并以框架的形式显示。通过使用 <code>iframe</code> 标签，可以在一个网页中显示多个不同的网页或文档，将不同的内容组合在一起展示。可以使用 <code>iframe</code> 来嵌入其他网站的内容、展示地图、播放视频等。</p> <p>假设 <code>iframe</code> 类名为 <code>extension-iframe</code>，这里设置类名而不是 <code>id</code> 名的初衷是，我们不能保证设置的名称原本的网站会不会已经存在，设置类名能共存。
发送消息使用 <code>window.parent.postMessage(message, '*');</code> 其中 <code>message</code> 为发送的消息</p> <p><strong>在父窗体端：</strong></p> <p>由于一个页面，可能有来自页面本身的 <code>postMessage</code> 来的消息，也有可能来自该页面其他 <code>chrome extension</code> 发送来的消息，因此用 <code>onmessage</code> 来监听，要做好区分来源</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果没消息就退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> iframes <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">&quot;extension-iframe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> extensionIframe <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存插件iframe节点对象</span>
    <span class="token keyword">var</span> correctSource <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否来源正确</span>
    <span class="token comment">// 找出真正的插件生成的iframe</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iframes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        iframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>contentWindow <span class="token operator">&amp;&amp;</span>
        event<span class="token punctuation">.</span>source <span class="token operator">===</span> iframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>contentWindow
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        correctSource <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        extensionIframe <span class="token operator">=</span> iframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果来源不是来自插件的，就退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>correctSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="父窗体向-iframe-发送消息"><a href="#父窗体向-iframe-发送消息" class="header-anchor">#</a> 父窗体向 <code>iframe</code> 发送消息</h4> <p><strong>在父窗体端：</strong></p> <p>使用 <code>extensionIframe.contentWindow.postMessage(message, '*');</code></p> <p>其中 <code>extensionIframe</code> 为插件的 <code>iframe</code> 节点对象，<code>message</code> 为发送的消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">'content-script'</span><span class="token punctuation">,</span> <span class="token literal-property property">other</span><span class="token operator">:</span> xxx<span class="token punctuation">}</span>
</code></pre></div><p><strong>在 iframe 端：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>from <span class="token operator">===</span> <span class="token string">'content-script'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">===</span> window<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在发送消息里增加了个 <code>from</code> 属性，进而进一步判断是不是来自父窗体自己插件的 <code>content script</code></p> <h2 id="插件内容发送-ajax-请求"><a href="#插件内容发送-ajax-请求" class="header-anchor">#</a> 插件内容发送 ajax 请求</h2> <p><code>chrome extension</code> 为了保证自己的优越性，允许在自己的程序里面，实现跨域请求</p> <p>插件要实现一些 <code>ajax</code> 请求，需要在 <code>background</code> 里实现</p> <p><code>ifame</code> 网站嵌入到别人页面的 <code>chrome extension</code></p> <h3 id="在插件生成的-iframe-网站里"><a href="#在插件生成的-iframe-网站里" class="header-anchor">#</a> 在插件生成的 <code>iframe</code> 网站里</h3> <p>在这个插件网站中，有一些按钮操作本身是要触发某些 ajax 请求的，由于不能直接在插件网站里发请求，而是先向父窗口发送消息，利用 <code>postMessage</code></p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">&quot;extension-iframe&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;loadTable&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">pageIndex</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">pageSize</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token literal-property property">sortProp</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">sortOrder</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>window.parent.postMessage</code> 是为了解决 <code>iframe</code> 跨域通信问题</p> <table><thead><tr><th style="text-align:center;">属性名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">from</td> <td style="text-align:center;">标记这条消息来自哪里</td></tr> <tr><td style="text-align:center;">type</td> <td style="text-align:center;">操作的名称，如发送该 message 的操作的目的是为了加载表格</td></tr> <tr><td style="text-align:center;">data</td> <td style="text-align:center;">发送请求的 data</td></tr></tbody></table> <h3 id="在插件的-content-script-里"><a href="#在插件的-content-script-里" class="header-anchor">#</a> 在插件的 <code>content script</code> 里</h3> <p>监听发来的消息</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> responseData <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 来自插件内嵌网站的消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseData<span class="token punctuation">.</span>from <span class="token operator">===</span> <span class="token string">&quot;extension-iframe&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ① 判断是否自己插件的iframe 区分来源</span>
      <span class="token keyword">var</span> iframes <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">&quot;extension-iframe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> extensionIframe <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> correctSource <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iframes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          iframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>contentWindow <span class="token operator">&amp;&amp;</span>
          event<span class="token punctuation">.</span>source <span class="token operator">===</span> iframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>contentWindow
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          correctSource <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          extensionIframe <span class="token operator">=</span> iframes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>correctSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ② 加载表格、提交信息等请求操作</span>
      <span class="token comment">// 该数组为iframe传来各个操作的名称，对应发来的消息的type属性</span>
      <span class="token keyword">var</span> operators <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;loadTable&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getNonMarkedCount&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getUrl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果跟操作匹配上了，就转发给background</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>operators<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>responseData<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> responseData<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> responseData<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返回请求后的数据给iframe网站</span>
            extensionIframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>
              <span class="token punctuation">{</span>
                <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">&quot;extension-content-script&quot;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> responseData<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                <span class="token literal-property property">response</span><span class="token operator">:</span> response<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string">&quot;*&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在插件的-background-script-里"><a href="#在插件的-background-script-里" class="header-anchor">#</a> 在插件的 <code>background script</code> 里</h3> <p>监听刚转发过来的消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这是所有请求组成对象</span>
<span class="token keyword">var</span> httpService <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">loadTable</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> eodHttp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/brandimageservice/perspective/mark'</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">submit</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> eodHttp<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/brandimageservice/perspective/mark'</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 监听刚转发过来的消息</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 该数组为iframe传来各个操作的名称，对应发来的消息的type属性</span>
    <span class="token keyword">var</span> operators <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'loadTable'</span><span class="token punctuation">,</span> <span class="token string">'submit'</span><span class="token punctuation">,</span> <span class="token string">'getNonMarkedCount'</span><span class="token punctuation">,</span> <span class="token string">'getUrl'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>operators<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里的type刚好与请求的属性名一致</span>
        httpService<span class="token punctuation">[</span>request<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 把请求的结果回传给content script</span>
            <span class="token function">sendResponse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里做了请求拦截，如果不是canceled的请求报错，则把报错信息也回传给content script</span>
            <span class="token punctuation">(</span>e<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此处return true是为了把sendResponse作为异步处理。</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="再返回到插件生成的-iframe-网站里"><a href="#再返回到插件生成的-iframe-网站里" class="header-anchor">#</a> 再返回到插件生成的 <code>iframe</code> 网站里</h3> <p>绕回到这个 <code>ifame</code> 里，最终的请求的数据还是会流回这里。</p> <div class="language-js extra-class"><pre class="language-js"><code> window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>from <span class="token operator">===</span> <span class="token string">'extension-content-script'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">===</span> window<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 以下为请求返回内容</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> result<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
        <span class="token comment">// 加载表格数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'loadTable'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>整个流程是 <strong>iframe</strong> -&gt; <strong>content script</strong> -&gt; <strong>background</strong> -&gt; <strong>content script</strong> -&gt; <strong>iframe</strong></p> <p>以 <code>background</code> 为中分线，前半截为发送请求，后半截为获取请求数据。</p> <h2 id="检测-chrome-extension-是否已经安装"><a href="#检测-chrome-extension-是否已经安装" class="header-anchor">#</a> 检测 <code>chrome extension</code> 是否已经安装</h2> <p>有一些 <code>chrome extension</code>，可能不是通过点击浏览器工具栏上的插件图标来激活插件，可能是通过点击网站上某个按钮来激活插件，需要检测浏览器是否安装了要求的 <code>chrome extension</code> ，如果没有进行提示。</p> <h2 id="扩展之间很容易相互影响"><a href="#扩展之间很容易相互影响" class="header-anchor">#</a> 扩展之间很容易相互影响</h2> <p>传递消息机制，容易受到牵连</p> <h2 id="代码调试"><a href="#代码调试" class="header-anchor">#</a> 代码调试</h2> <p><code>content script</code> 的调试：F12 -&gt; source -&gt; page</p> <img src="/blogs/images/chrome.png" alt=""> <p><code>backgroud script</code> 的调试：<code>chrome://extensions</code> 找到对应的扩展，点击背景视图，可以看到 <code>backgroud script</code> 进行调试，还能在控制台调用 <code>chrome api</code> ，请求也可以看到。</p> <h2 id="信息传递的异步性"><a href="#信息传递的异步性" class="header-anchor">#</a> 信息传递的异步性</h2> <p>考虑 <code>content script</code> 的插入时机是否对通信产生一定影响</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blogs/assets/js/app.ce7ede7b.js" defer></script><script src="/blogs/assets/js/2.487b4d99.js" defer></script><script src="/blogs/assets/js/15.33dd3631.js" defer></script>
  </body>
</html>
